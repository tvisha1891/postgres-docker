version: 2.0
jobs:
  deploy:
    parallelism: 15
    machine:
      enabled: true
    working_directory: /home/circleci/postgres
    environment:
      DOCKER_IMAGE=circleci/postgres-script-enhance
    resource_class: large

    steps:
      - checkout

      - run:
          name: Build image
          command: docker build -t $DOCKER_IMAGE .

      - run:
          name: Tag and deploy image to docker hub
          command: |
            lscpu
  build:
    parallelism: 15
    machine:
      enabled: true
    working_directory: /home/circleci/postgres
    environment:
      DOCKER_IMAGE=circleci/postgres-script-enhance
    resource_class: large

    steps:
      - checkout

      - run:
          name: Build image
          command: docker build -t $DOCKER_IMAGE .

      - run:
          name: Tag and deploy image to docker hub
          command: |
            sleep 1h

workflows:
  version: 2
  deploy:
    jobs:
      - deploy:
          filters:
            branches:
              only: master
      - build:
          filters:
            branches:
              only: master
